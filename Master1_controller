import threading
import time
import socket
import logging
import os
import re
import pymongo
import json
#controller1
# controller to test black controller

def get_bd_address(ether_adapter):
    ip_data = os.popen("ifconfig " + ether_adapter)
    for line in ip_data:
        match2 = re.search(r'Bcast:+(\d+.\d+.\d+.\d+)', line)
        if match2:
            bcast = match2.group(1)
            return bcast

def get_ip_data(ether_adapter):
    ip_data = os.popen("ifconfig " + ether_adapter)
    for line in ip_data:
        match2 = re.search(r'inet addr:+(\d+.\d+.\d+.\d+)', line)
        if match2:
            ip_ = match2.group(1)

            return ip_

def broadcast(Host,port):
    #send bd
    sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
    msg=get_ip_data("wlp3s0")
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
    time.sleep(1.5)
    conn = (time.clock())
    # print("yes sending", client)
    se = str(conn)
    savefile = open('/home/keerthana/Downloads/sending.txt', 'a')
    savefile.write('\n')
    savefile.write(''.join(se))
    savefile.close()
    sock.sendto(msg.encode(), (Host,port))
'''    
def recv():
    sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
    host="192.168.1.27"
    port=8976
    address=host,port
    sock.bind(address)
    while True:
        msg,b=sock.recvfrom(1024)
        print(msg.decode)
'''
def broadcast_recv():
    #listen bd
    sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
    sock.bind((get_bd_address("wlp3s0"),12345))
    # receive broadcast
    msg, client = sock.recvfrom(1024)
    a=(msg.decode())
    host=a
    #other controller port
    port=8976
    address=(host,port)
    payload={"controller":'hello and my ip is 192.168.1.27'}
    json_data=json.dumps(payload)
    print("sending".format(**payload))
    sock.sendto(json_data.encode(),address)
    #print("sent my hello to other controller",payload)

def parserr(payload):
    uri = "mongodb://localhost:27017"
    client = pymongo.MongoClient(uri)
    db = client['orchtrail']
    collection = db['testData']
    collection.insert(payload)
    testData = collection.find({})
    for test in testData:
        print(test)


def talkToClient(ip):
    logging.info("sending 'clients we received your data' to %s",ip )

    sock=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
    sock.sendto("ok".encode('utf-8'), ip)

def listen_clients(Host,port):
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind((Host,port))
    client_list=[]
    #listen to multiple clients
    while True:
        msgg, client = sock.recvfrom(1024)
        json_data = b""
        json_data += msgg
        payload = json.loads(json_data.decode())
        if ("controller" in payload):
            print("controller sent this ", payload)
            # comm btw controller2 and main controller
            con=time.clock()
            #print("yes sending", client)
            sending=str(con)
            savefile=open('/home/keerthana/Downloads/recv.txt','a')
            savefile.write('\n')
            savefile.write(''.join(sending))
            savefile.close()


        else:

        #print("msg".format(**payload))
            print('connected with : ' + client[0]+ ':' + str(client[1]))
            t4 = threading.Thread(target=parserr, args=(payload,))
            t4.start()

            t = threading.Thread(target=talkToClient, args=(client,))
            t.start()

if __name__=="__main__":
    ethernet_card = "wlp3s0"
    bd_of_the_machine = get_bd_address(ethernet_card)
    ip_of_the_machine = get_ip_data(ethernet_card)
    t1 = threading.Thread(target=broadcast, name='broad_send', args=(bd_of_the_machine, 9289))
    t2 = threading.Thread(target=broadcast_recv,name='recv bd')
    #t5=threading.Thread(target=recv,name= "recv ok",args="",)
    t3 = threading.Thread(target=listen_clients,name='listening client',args=(ip_of_the_machine,4242))
    t1.start()
    #t5.start()
    t2.start()
    t3.start()

